/*! jquery.pjaxr v1.1.0 | Copyright (c) 2013-2014 Stephan GroÃŸ | MIT license | minddust.com */
!function(e){"use strict";function t(e,t){return this.on("click.pjaxr",e,function(e){r(e,t)})}function a(a,r){if("string"==typeof a){var n=document.createElement("A");n.href=a,a=n}if("A"!==a.tagName.toUpperCase())throw"$.fn.pjaxr requires an anchor element";if((location.protocol===a.protocol&&location.hostname===a.hostname||":"===a.protocol&&""===a.hostname)&&(!a.hash||a.href.replace(a.hash,"")!==location.href.replace(location.hash,""))&&a.href!==location.href+"#"){var u={url:e.isFunction(a.href)?a.href():a.href,type:"GET",dataType:"html"},h=t.options=e.extend(!0,{},e.ajaxSettings,u,e.fn.pjaxr.defaults,r);v||(v=e("body").data("pjaxr-namespace")||"");var d;h.beforeSend=function(e,t){return s("pjaxr:beforeSend",[e,t])?(e.setRequestHeader("X-PJAX","true"),e.setRequestHeader("X-PJAX-NAMESPACE",v),t.timeout>0&&(d=setTimeout(function(){s("pjaxr:timeout",[e,h])&&e.abort("timeout")},t.timeout),t.timeout=0),!0):!1},t.state||(t.state={id:l(),namespace:v,url:window.location.href,title:document.title},window.history.replaceState(t.state,t.state.title,t.state.url));var f=t.xhr;f&&f.readyState<4&&(f.onreadystatechange=e.noop,f.abort()),f=t.xhr=e.ajax(h),f.readyState>0&&(s("pjaxr:start",[h]),s("pjaxr:send",[h])),f.done(function(a,r,n){s("pjaxr:success",[h]);var u="function"==typeof h.version?h.version():h.version,d=n.getResponseHeader("X-PJAX-Version");if(u&&d&&u!==d)return void c(h.url);var f=a.match(/<pjaxr-head>([\s\S.]*)<\/pjaxr-head>/i),m=a.match(/<pjaxr-body>([\s\S.]*)<\/pjaxr-body>/i);if(!f&&!m)return void c(h.url);s("pjaxr:success",[a,r,n,h]),document.activeElement.blur();var x=l();if(f)var w=e(p(f[0])),y=o("forward",w.children(),null,null),j=y[0],b=y[1],g=y[2];if(m)var S=e(p(m[0])),A=i(S.children()),T=A[0],P=A[1];var _=a.match(/<pjaxr-namespace>([\s\S.]*)<\/pjaxr-namespace>/i);_&&(v=e(p(_[0])).html()),e(document).find("input[autofocus], textarea[autofocus]").last().focus(),"number"==typeof h.scrollTo&&e(window).scrollTop(h.scrollTo),e.extend(t.state,{head_revert:f?b:null,head_remove:f?g:null,body_revert:m?P:null}),(h.push||h.replace)&&window.history.replaceState(t.state,t.state.title,t.state.url),t.state={id:x,namespace:v,url:h.url,title:document.title,head_apply:f?j:null,body_apply:m?T:null},h.push?window.history.pushState(t.state,t.state.title,t.state.url):h.replace&&window.history.replaceState(t.state,t.state.title,t.state.url),s("pjaxr:done",[a,r,n,h])}),f.fail(function(e,t,a){"abort"!==t&&s("pjaxr:fail",[e,t,a,h])&&c(h.url)}),f.always(function(){d&&clearTimeout(d),s("pjaxr:always",[h]),s("pjaxr:end",[h])})}}function r(e,t){var r=e.currentTarget;if("A"!==r.tagName.toUpperCase())throw"$.fn.pjaxr requires an anchor element";if(!(e.which>1||e.metaKey||e.ctrlKey||e.shiftKey||e.altKey||e.isDefaultPrevented())){if(!s("pjaxr:click"))return void e.preventDefault();a(r,t),e.preventDefault()}}function n(t,a){var r=[],n=[],o=[];return t&&t.length>0&&e.each(t,function(t,i){var s=e(i);if(s.is("title"))document.title=s.text();else if(s.is("meta")){var p,l=s.attr("name"),c=s.attr("property");l?p=e('head > meta[name="'+l+'"]'):c&&(p=e('head > meta[property="'+c+'"]')),p.length>0?(o.push(u(p)),p.remove()):n.push(u(s)),a===!0&&(e("head").append(s),r.push(u(s)))}else if(s.is("link")){var h=s.attr("href");if(h){var d=e('head > link[href="'+h+'"]');d.length>0?(o.push(u(d)),d.remove()):n.push(u(s)),a===!0&&(e("head").append(s),r.push(u(s)))}}else if(s.is("script")){var f=s.attr("src");if(f){var m=e('head > script[src="'+f+'"]');m.length>0?(o.push(u(m)),m.remove()):n.push(u(s)),a===!0&&(e("head").append(s),r.push(u(s)))}}else s.is("style")&&a===!0&&(e("head").append(s),r.push(u(s)),n.push(u(s)))}),[r,n,o]}function o(t,a,r,o){var i=[],s=[],p=[];if("forward"===t)e("head > [data-remove-on-pjaxr]").each(function(){var t=e(this);p.push(u(t)),t.remove()});else if("back"===t){var l=n(r,!1),c=n(o,!0);e.extend(s,l[1]),e.extend(p,c[2])}var h=n(a,!0);return e.extend(i,h[0]),e.extend(s,h[1]),e.extend(p,h[2]),[i,s,p]}function i(t){var a=[],r=[];return t&&t.length>0&&e.each(t,function(t,n){var o=e(n),i=o.attr("id");if(i){var s=e("#"+i);if(s.length>0){r.push(u(s));try{s.html(o.html())}catch(p){window.console&&console.error(p)}a.push(u(s))}}}),[a,r]}function s(t,a){var r=e.Event(t);return e(document).trigger(r,a),!r.isDefaultPrevented()}function p(t){return e.parseHTML(t,document,!0)}function u(e){return e.clone().wrap("<p>").parent().html()}function l(){return(new Date).getTime()}function c(e){window.history.replaceState(null,"","#"),window.location.replace(e)}function h(e){var a=e.state;if(a){if(x&&w==a.url)return;s("pjaxr:start",[t.options]),document.title=a.title;var r=t.state.id<a.id?"forward":"back";o(r,a.head_apply,a.head_revert,a.head_remove);var n="forward"===r?a.body_apply:a.body_revert;n&&n.length>0&&i(n),t.state=a,v=a.namespace,document.body.offsetHeight,s("pjaxr:end",[t.options])}x=!1}function d(){return e("meta").filter(function(){return"X-PJAX-VERSION"===String(e(this).attr("http-equiv")).toUpperCase()}).attr("content")}function f(){e.fn.pjaxr=t,e.fn.pjaxr.click=r,e.fn.pjaxr.request=a,e.fn.pjaxr.enable=e.noop,e.fn.pjaxr.disable=m,e.fn.pjaxr.defaults={timeout:650,push:!0,replace:!1,scrollTo:0,version:d},e(window).on("popstate.pjaxr",h)}function m(){e.fn.pjaxr=function(){return this},e.fn.pjaxr.enable=f,e.fn.pjaxr.disable=e.noop,e(window).off("popstate.pjaxr",h)}var v,x=!0,w=window.location.href,y=window.history.state;y&&(t.state=y),"state"in window.history&&(x=!1),e.inArray("state",e.event.props)<0&&e.event.props.push("state"),e.support.pjaxr=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/),e.support.pjaxr?f():m()}(jQuery);