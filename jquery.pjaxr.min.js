/*! jQuery.pjaxR v1.0.4 | Copyright (c) 2013 Stephan Gross | MIT License | minddust.com */
(function(a){function c(a,c){return this.on("click.pjaxr",a,function(a){p(a,c)})}function p(d,h){var b=d.currentTarget;if("A"!==b.tagName.toUpperCase())throw"$.fn.pjaxXR requires an anchor element";if(!(1<d.which||d.metaKey||d.ctrlKey||d.shiftKey||d.altKey||d.isDefaultPrevented()||location.protocol!==b.protocol||location.hostname!==b.hostname||b.hash&&b.href.replace(b.hash,"")===location.href.replace(location.hash,"")||b.href===location.href+"#")){var b={url:a.isFunction(b.href)?b.href():b.href,type:"GET",dataType:"html"},e=c.options=a.extend(!0,{},a.ajaxSettings,b,a.fn.pjaxr.defaults,h);if(k("pjaxr:click",[e])){var l;e.beforeSend=function(d,b){if(!k("pjaxr:beforeSend",[d,b]))return!1;d.setRequestHeader("X-PJAX","true");s||(s=a("body").data("pjaxr-namespace")||"");d.setRequestHeader("X-PJAX-NAMESPACE",s);0<b.timeout&&(l=setTimeout(function(){k("pjaxr:timeout",[d,e])&&d.abort("timeout")},b.timeout),b.timeout=0);return!0};c.state||(c.state={id:(new Date).getTime(),url:window.location.href,title:document.title},window.history.replaceState(c.state,c.state.title,c.state.url));(b=c.xhr)&&4>b.readyState&&(b.onreadystatechange=a.noop,b.abort());b=c.xhr=a.ajax(e);0<b.readyState&&k("pjaxr:start",[e]);b.done(function(d,b,g){k("pjaxr:success",[e]);var f="function"===typeof e.version?e.version():e.version,h=g.getResponseHeader("X-PJAX-Version");if(f&&h&&f!==h)v(e.url);else if(f=d.match(/<pjaxr-head>([\s\S.]*)<\/pjaxr-head>/i),h=d.match(/<pjaxr-body>([\s\S.]*)<\/pjaxr-body>/i),f||h){k("pjaxr:success",[d,b,g,e]);document.activeElement.blur();var l=(new Date).getTime();if(f)var u=a(a.parseHTML(f[0],document,!0)),q=w("forward",u.children(),null,null),u=q[0],r=q[1],q=q[2];if(h)var m=a(a.parseHTML(h[0],document,!0)),t=x(m.children()),m=t[0],t=t[1];var p=d.match(/<pjaxr-namespace>([\s\S.]*)<\/pjaxr-namespace>/i);p&&(s=a(a.parseHTML(p[0],document,!0)).html());a(document).find("input[autofocus], textarea[autofocus]").last().focus();"number"===typeof e.scrollTo&&a(window).scrollTop(e.scrollTo);a.extend(c.state,{head_revert:f?r:null,head_remove:f?q:null,body_revert:h?t:null});(e.push||e.replace)&&window.history.replaceState(c.state,c.state.title,c.state.url);c.state={id:l,url:e.url,title:document.title,head_apply:f?u:null,body_apply:h?m:null};e.push?window.history.pushState(c.state,c.state.title,c.state.url):e.replace&&window.history.replaceState(c.state,c.state.title,c.state.url);k("pjaxr:done",[d,b,g,e])}else v(e.url)});b.fail(function(a,d,b){"abort"!==d&&k("pjaxr:fail",[a,d,b,e])&&v(e.url)});b.always(function(){l&&clearTimeout(l);k("pjaxr:always",[e]);k("pjaxr:end",[e])})}d.preventDefault()}}function r(d,h){var b=[],e=[],c=[];d&&0<d.length&&a.each(d,function(d,n){var g=a(n);if(g.is("title"))document.title=g.text();else if(g.is("meta")){var f,k=g.attr("name"),m=g.attr("property");k?f=a('head > meta[name="'+k+'"]'):m&&(f=a('head > meta[property="'+m+'"]'));0<f.length?(c.push(l(f)),f.remove()):e.push(l(g));!0===h&&(a("head").append(g),b.push(l(g)))}else if(g.is("link")){if(f=g.attr("href"))f=a('head > link[href="'+f+'"]'),0<f.length?(c.push(l(f)),f.remove()):e.push(l(g)),!0===h&&(a("head").append(g),b.push(l(g)))}else if(g.is("script")){if(f=g.attr("src"))f=a('head > script[src="'+f+'"]'),0<f.length?(c.push(l(f)),f.remove()):e.push(l(g)),!0===h&&(a("head").append(g),b.push(l(g)))}else g.is("style")&&!0===h&&(a("head").append(g),b.push(l(g)),e.push(l(g)))});return[b,e,c]}function w(d,c,b,e){var k=[],m=[],n=[];"forward"===d?a("head > [data-remove-on-pjaxr]").each(function(){var d=a(this);n.push(l(d));d.remove()}):"back"===d&&(d=r(b,!1),e=r(e,!0),a.extend(m,d[1]),a.extend(n,e[2]));c=r(c,!0);a.extend(k,c[0]);a.extend(m,c[1]);a.extend(n,c[2]);return[k,m,n]}function x(d){var c=[],b=[];d&&0<d.length&&a.each(d,function(d,k){var m=a(k),n=m.attr("id");n&&(n=a("#"+n),0<n.length&&(b.push(l(n)),n.html(m.html()),c.push(l(n))))});return[c,b]}function k(d,c){var b=a.Event(d);a(document).trigger(b,c);return!b.isDefaultPrevented()}function l(a){return a.clone().wrap("<p>").parent().html()}function v(a){window.history.replaceState(null,"","#");window.location.replace(a)}function y(a){if(a=a.state){if(m&&C==a.url)return;k("pjaxr:start",[c.options]);document.title=a.title;var h=c.state.id<a.id?"forward":"back";w(h,a.head_apply,a.head_revert,a.head_remove);(h="forward"===h?a.body_apply:a.body_revert)&&0<h.length&&x(h);c.state=a;document.body.offsetHeight;k("pjaxr:end",[c.options])}m=!1}function D(){return a("meta").filter(function(){return"X-PJAX-VERSION"===String(a(this).attr("http-equiv")).toUpperCase()}).attr("content")}function z(){a.fn.pjaxr=c;a.fn.pjaxr.click=p;a.fn.pjaxr.enable=a.noop;a.fn.pjaxr.disable=A;a.fn.pjaxr.defaults={timeout:650,push:!0,replace:!1,scrollTo:0,version:D};a(window).on("popstate.pjaxr",y)}function A(){a.fn.pjaxr=function(){return this};a.fn.pjaxr.enable=z;a.fn.pjaxr.disable=a.noop;a(window).off("popstate.pjaxr",y)}var m=!0,C=window.location.href,B=window.history.state,s;B&&(c.state=B);"state"in window.history&&(m=!1);0>a.inArray("state",a.event.props)&&a.event.props.push("state");a.support.pjaxr=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/);a.support.pjaxr?z():A()})(jQuery);