/*! jQuery.pjaxR v1.0.4 | Copyright (c) 2013 Stephan Gross | MIT License | minddust.com */
(function(a){function b(a,b){return this.on("click.pjaxr",a,function(a){q(a,b)})}function q(c,h){var d=c.currentTarget;if("A"!==d.tagName.toUpperCase())throw"$.fn.pjaxXR requires an anchor element";if(!(1<c.which||c.metaKey||c.ctrlKey||c.shiftKey||c.altKey||c.isDefaultPrevented()||location.protocol!==d.protocol||location.hostname!==d.hostname||d.hash&&d.href.replace(d.hash,"")===location.href.replace(location.hash,"")||d.href===location.href+"#")){var d={url:a.isFunction(d.href)?d.href():d.href,type:"GET",dataType:"html"},e=b.options=a.extend(!0,{},a.ajaxSettings,d,a.fn.pjaxr.defaults,h);if(k("pjaxr:click",[e])){p||(p=a("body").data("pjaxr-namespace")||"");var l;e.beforeSend=function(a,c){if(!k("pjaxr:beforeSend",[a,c]))return!1;a.setRequestHeader("X-PJAX","true");a.setRequestHeader("X-PJAX-NAMESPACE",p);0<c.timeout&&(l=setTimeout(function(){k("pjaxr:timeout",[a,e])&&a.abort("timeout")},c.timeout),c.timeout=0);return!0};b.state||(b.state={id:(new Date).getTime(),namespace:p,url:window.location.href,title:document.title},window.history.replaceState(b.state,b.state.title,b.state.url));(d=b.xhr)&&4>d.readyState&&(d.onreadystatechange=a.noop,d.abort());d=b.xhr=a.ajax(e);0<d.readyState&&k("pjaxr:start",[e]);d.done(function(c,d,g){k("pjaxr:success",[e]);var f="function"===typeof e.version?e.version():e.version,h=g.getResponseHeader("X-PJAX-Version");if(f&&h&&f!==h)v(e.url);else if(f=c.match(/<pjaxr-head>([\s\S.]*)<\/pjaxr-head>/i),h=c.match(/<pjaxr-body>([\s\S.]*)<\/pjaxr-body>/i),f||h){k("pjaxr:success",[c,d,g,e]);document.activeElement.blur();var l=(new Date).getTime();if(f)var u=a(a.parseHTML(f[0],document,!0)),r=w("forward",u.children(),null,null),u=r[0],s=r[1],r=r[2];if(h)var m=a(a.parseHTML(h[0],document,!0)),t=x(m.children()),m=t[0],t=t[1];var q=c.match(/<pjaxr-namespace>([\s\S.]*)<\/pjaxr-namespace>/i);q&&(p=a(a.parseHTML(q[0],document,!0)).html());a(document).find("input[autofocus], textarea[autofocus]").last().focus();"number"===typeof e.scrollTo&&a(window).scrollTop(e.scrollTo);a.extend(b.state,{head_revert:f?s:null,head_remove:f?r:null,body_revert:h?t:null});(e.push||e.replace)&&window.history.replaceState(b.state,b.state.title,b.state.url);b.state={id:l,namespace:p,url:e.url,title:document.title,head_apply:f?u:null,body_apply:h?m:null};e.push?window.history.pushState(b.state,b.state.title,b.state.url):e.replace&&window.history.replaceState(b.state,b.state.title,b.state.url);k("pjaxr:done",[c,d,g,e])}else v(e.url)});d.fail(function(a,c,d){"abort"!==c&&k("pjaxr:fail",[a,c,d,e])&&v(e.url)});d.always(function(){l&&clearTimeout(l);k("pjaxr:always",[e]);k("pjaxr:end",[e])})}c.preventDefault()}}function s(c,h){var d=[],e=[],b=[];c&&0<c.length&&a.each(c,function(c,n){var g=a(n);if(g.is("title"))document.title=g.text();else if(g.is("meta")){var f,k=g.attr("name"),m=g.attr("property");k?f=a('head > meta[name="'+k+'"]'):m&&(f=a('head > meta[property="'+m+'"]'));0<f.length?(b.push(l(f)),f.remove()):e.push(l(g));!0===h&&(a("head").append(g),d.push(l(g)))}else if(g.is("link")){if(f=g.attr("href"))f=a('head > link[href="'+f+'"]'),0<f.length?(b.push(l(f)),f.remove()):e.push(l(g)),!0===h&&(a("head").append(g),d.push(l(g)))}else if(g.is("script")){if(f=g.attr("src"))f=a('head > script[src="'+f+'"]'),0<f.length?(b.push(l(f)),f.remove()):e.push(l(g)),!0===h&&(a("head").append(g),d.push(l(g)))}else g.is("style")&&!0===h&&(a("head").append(g),d.push(l(g)),e.push(l(g)))});return[d,e,b]}function w(c,b,d,e){var k=[],m=[],n=[];"forward"===c?a("head > [data-remove-on-pjaxr]").each(function(){var c=a(this);n.push(l(c));c.remove()}):"back"===c&&(c=s(d,!1),e=s(e,!0),a.extend(m,c[1]),a.extend(n,e[2]));b=s(b,!0);a.extend(k,b[0]);a.extend(m,b[1]);a.extend(n,b[2]);return[k,m,n]}function x(c){var b=[],d=[];c&&0<c.length&&a.each(c,function(c,k){var m=a(k),n=m.attr("id");n&&(n=a("#"+n),0<n.length&&(d.push(l(n)),n.html(m.html()),b.push(l(n))))});return[b,d]}function k(c,b){var d=a.Event(c);a(document).trigger(d,b);return!d.isDefaultPrevented()}function l(a){return a.clone().wrap("<p>").parent().html()}function v(a){window.history.replaceState(null,"","#");window.location.replace(a)}function y(a){if(a=a.state){if(m&&C==a.url)return;k("pjaxr:start",[b.options]);document.title=a.title;var h=b.state.id<a.id?"forward":"back";w(h,a.head_apply,a.head_revert,a.head_remove);(h="forward"===h?a.body_apply:a.body_revert)&&0<h.length&&x(h);b.state=a;document.body.offsetHeight;k("pjaxr:end",[b.options])}m=!1}function D(){return a("meta").filter(function(){return"X-PJAX-VERSION"===String(a(this).attr("http-equiv")).toUpperCase()}).attr("content")}function z(){a.fn.pjaxr=b;a.fn.pjaxr.click=q;a.fn.pjaxr.enable=a.noop;a.fn.pjaxr.disable=A;a.fn.pjaxr.defaults={timeout:650,push:!0,replace:!1,scrollTo:0,version:D};a(window).on("popstate.pjaxr",y)}function A(){a.fn.pjaxr=function(){return this};a.fn.pjaxr.enable=z;a.fn.pjaxr.disable=a.noop;a(window).off("popstate.pjaxr",y)}var m=!0,C=window.location.href,B=window.history.state,p;B&&(b.state=B);"state"in window.history&&(m=!1);0>a.inArray("state",a.event.props)&&a.event.props.push("state");a.support.pjaxr=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/);a.support.pjaxr?z():A()})(jQuery);