/*! jQuery.pjaxR v1.0.0 | Copyright (c) 2013 Stephan Gross | MIT License | minddust.com */
(function(a){function c(b,p){return this.on("click.pjaxr",b,function(b){var d=b.currentTarget;if("A"!==d.tagName.toUpperCase())throw"$.fn.pjaxXR requires an anchor element";if(!(1<b.which||b.metaKey||b.ctrlKey||b.shiftKey||b.altKey||b.isDefaultPrevented()||location.protocol!==d.protocol||location.hostname!==d.hostname||d.hash&&d.href.replace(d.hash,"")===location.href.replace(location.hash,"")||d.href===location.href+"#")){var d={url:a.isFunction(d.href)?d.href():d.href,type:"GET",dataType:"html",target:d},f=c.options=a.extend(!0,{},a.ajaxSettings,d,a.fn.pjaxr.defaults,p);if(k("pjaxr:click",[f])){var e;f.beforeSend=function(a,b){if(!k("pjaxr:beforeSend",[a,b]))return!1;a.setRequestHeader("X-PJAX","true");0<b.timeout&&(e=setTimeout(function(){k("pjaxr:timeout",[a,f])&&a.abort("timeout")},b.timeout),b.timeout=0);return!0};c.state||(c.state={id:(new Date).getTime(),url:window.location.href,title:document.title},window.history.replaceState(c.state,c.state.title,c.state.url));(d=c.xhr)&&4>d.readyState&&(d.onreadystatechange=a.noop,d.abort());d=c.xhr=a.ajax(f);0<d.readyState&&k("pjaxr:start",[f]);d.done(function(b,d,p){var e="function"===typeof f.version?f.version():f.version,h=p.getResponseHeader("X-PJAX-Version");if(e&&h&&e!==h)n(f.url);else if(f.push||f.replace)if(e=b.match(/<pjaxr-head>([\s\S.]*)<\/pjaxr-head>/i),h=b.match(/<pjaxr-body>([\s\S.]*)<\/pjaxr-body>/i),e||h){document.activeElement.blur();var B=(new Date).getTime();if(e)var m=a(a.parseHTML(e[0],document,!0)),r=u("forward",m.children(),null),m=r[0],r=r[1];if(h)var t=a(a.parseHTML(h[0],document,!0)),s=v(t.children()),t=s[0],s=s[1];a(document).find("input[autofocus], textarea[autofocus]").last().focus();"number"===typeof f.scrollTo&&a(window).scrollTop(f.scrollTo);a.extend(c.state,{head_revert:e?r:null,body_revert:h?s:null});window.history.replaceState(c.state,c.state.title,c.state.url);c.state={id:B,url:f.url,title:document.title,head_apply:e?m:null,body_apply:h?t:null};f.push?window.history.pushState(c.state,c.state.title,c.state.url):f.replace&&window.history.replaceState(c.state,c.state.title,c.state.url);k("pjaxr:done",[b,d,p,f])}else n(f.url);else n(f.url)});d.fail(function(a,b,d){"abort"!==b&&k("pjaxr:fail",[a,b,d,f])&&n(f.url)});d.always(function(){e&&clearTimeout(e);k("pjaxr:always",[f]);k("pjaxr:end",[f])})}b.preventDefault()}})}function w(b,c){var h=[],d=[];b&&0<b.length&&a.each(b,function(b,k){var g=a(k);g.is("title")&&(document.title=g.text());if(g.is("meta")){var l,m=g.attr("name"),n=g.attr("property");m?l=a("head > meta[name="+m+"]"):n&&(l=a("head > meta[property="+n+"]"));0<l.length?(d.push(e(l)),l.remove()):d.push(e(g));!0===c&&(a("head").append(g),h.push(e(g)))}if(g.is("link")&&(l=g.attr("href"))){var q=a("head > link[href="+l+"]");0<q.length?(d.push(e(q)),q.remove()):d.push(e(g));!0===c&&(a("head").append(g),h.push(e(g)))}g.is("script")&&(l=g.attr("href"))&&(l=a("head > script[href="+l+"]"),0<l.length?(d.push(e(q)),l.remove()):d.push(e(l)),!0===c&&(a("head").append(g),h.push(e(g))));g.is("style")&&!0===c&&(a("head").append(g),h.push(e(g)),d.push(e(g)))});return[h,d]}function u(b,c,h){var d=[],f=[];"forward"===b?a("head > [data-remove-on-pjaxr]").each(function(){var b=a(this);f.push(e(b));b.remove()}):"back"===b&&(b=w(h,!1),a.extend(f,b[1]));c=w(c,!0);a.extend(d,c[0]);a.extend(f,c[1]);return[d,f]}function v(b){var c=[],h=[];b&&0<b.length&&a.each(b,function(b,f){var k=a(f),g=k.attr("id");g&&(g=a("#"+g),0<g.length&&(h.push(e(g)),g.html(k.html()),c.push(e(g))))});return[c,h]}function k(b,e){var h=a.Event(b,{relatedTarget:c.options.target});a(document).trigger(h,e);return!h.isDefaultPrevented()}function e(a){return a.clone().wrap("<p>").parent().html()}function n(a){window.history.replaceState(null,"","#");window.location.replace(a)}function x(a){if(a=a.state){if(m&&C==a.url)return;k("pjaxr:start",[c.options]);document.title=a.title;var e=c.state.id<a.id?"forward":"back";u(e,a.head_apply,a.head_revert);(e="forward"===e?a.body_apply:a.body_revert)&&0<e.length&&v(e);c.state=a;document.body.offsetHeight;k("pjaxr:end",[c.options])}m=!1}function D(){return a("meta").filter(function(){return"X-PJAX-VERSION"===String(a(this).attr("http-equiv")).toUpperCase()}).attr("content")}function y(){a.fn.pjaxr=c;a.fn.pjaxr.enable=a.noop;a.fn.pjaxr.disable=z;a.fn.pjaxr.defaults={timeout:650,push:!0,replace:!1,scrollTo:0,version:D};a(window).on("popstate.pjaxr",x)}function z(){a.fn.pjaxr=function(){return this};a.fn.pjaxr.enable=y;a.fn.pjaxr.disable=a.noop;a(window).off("popstate.pjaxr",x)}var m=!0,C=window.location.href,A=window.history.state;A&&(c.state=A);"state"in window.history&&(m=!1);0>a.inArray("state",a.event.props)&&a.event.props.push("state");a.support.pjaxr=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/);a.support.pjaxr?y():z()})(jQuery);