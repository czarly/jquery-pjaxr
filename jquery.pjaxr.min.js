/*! jquery.pjaxr v1.0.6 | Copyright (c) 2013 Stephan Gross | MIT License | minddust.com */
!function(a){"use strict";function b(a,b){return this.on("click.pjaxr",a,function(a){d(a,b)})}function c(c,d){if("string"==typeof c){var e=document.createElement("A");e.href=c,c=e}if("A"!==c.tagName.toUpperCase())throw"$.fn.pjaxr requires an anchor element";if(location.protocol===c.protocol&&location.hostname===c.hostname&&(!c.hash||c.href.replace(c.hash,"")!==location.href.replace(location.hash,""))&&c.href!==location.href+"#"){var j={url:a.isFunction(c.href)?c.href():c.href,type:"GET",dataType:"html"},m=b.options=a.extend(!0,{},a.ajaxSettings,j,a.fn.pjaxr.defaults,d);q||(q=a("body").data("pjaxr-namespace")||"");var n;m.beforeSend=function(a,b){return h("pjaxr:beforeSend",[a,b])?(a.setRequestHeader("X-PJAX","true"),a.setRequestHeader("X-PJAX-NAMESPACE",q),b.timeout>0&&(n=setTimeout(function(){h("pjaxr:timeout",[a,m])&&a.abort("timeout")},b.timeout),b.timeout=0),!0):!1},b.state||(b.state={id:k(),namespace:q,url:window.location.href,title:document.title},window.history.replaceState(b.state,b.state.title,b.state.url));var o=b.xhr;o&&o.readyState<4&&(o.onreadystatechange=a.noop,o.abort()),o=b.xhr=a.ajax(m),o.readyState>0&&h("pjaxr:start",[m]),o.done(function(c,d,e){h("pjaxr:success",[m]);var j="function"==typeof m.version?m.version():m.version,n=e.getResponseHeader("X-PJAX-Version");if(j&&n&&j!==n)return l(m.url),void 0;var o=c.match(/<pjaxr-head>([\s\S.]*)<\/pjaxr-head>/i),p=c.match(/<pjaxr-body>([\s\S.]*)<\/pjaxr-body>/i);if(!o&&!p)return l(m.url),void 0;h("pjaxr:success",[c,d,e,m]),document.activeElement.blur();var r=k();if(o)var s=a(i(o[0])),t=f("forward",s.children(),null,null),u=t[0],v=t[1],w=t[2];if(p)var x=a(i(p[0])),y=g(x.children()),z=y[0],A=y[1];var B=c.match(/<pjaxr-namespace>([\s\S.]*)<\/pjaxr-namespace>/i);B&&(q=a(i(B[0])).html()),a(document).find("input[autofocus], textarea[autofocus]").last().focus(),"number"==typeof m.scrollTo&&a(window).scrollTop(m.scrollTo),a.extend(b.state,{head_revert:o?v:null,head_remove:o?w:null,body_revert:p?A:null}),(m.push||m.replace)&&window.history.replaceState(b.state,b.state.title,b.state.url),b.state={id:r,namespace:q,url:m.url,title:document.title,head_apply:o?u:null,body_apply:p?z:null},m.push?window.history.pushState(b.state,b.state.title,b.state.url):m.replace&&window.history.replaceState(b.state,b.state.title,b.state.url),h("pjaxr:done",[c,d,e,m])}),o.fail(function(a,b,c){"abort"!==b&&h("pjaxr:fail",[a,b,c,m])&&l(m.url)}),o.always(function(){n&&clearTimeout(n),h("pjaxr:always",[m]),h("pjaxr:end",[m])})}}function d(a,b){var d=a.currentTarget;if("A"!==d.tagName.toUpperCase())throw"$.fn.pjaxr requires an anchor element";if(!(a.which>1||a.metaKey||a.ctrlKey||a.shiftKey||a.altKey||a.isDefaultPrevented())){if(!h("pjaxr:click"))return a.preventDefault(),void 0;c(d,b),a.preventDefault()}}function e(b,c){var d=[],e=[],f=[];return b&&b.length>0&&a.each(b,function(b,g){var h=a(g);if(h.is("title"))document.title=h.text();else if(h.is("meta")){var i,k=h.attr("name"),l=h.attr("property");k?i=a('head > meta[name="'+k+'"]'):l&&(i=a('head > meta[property="'+l+'"]')),i.length>0?(f.push(j(i)),i.remove()):e.push(j(h)),c===!0&&(a("head").append(h),d.push(j(h)))}else if(h.is("link")){var m=h.attr("href");if(m){var n=a('head > link[href="'+m+'"]');n.length>0?(f.push(j(n)),n.remove()):e.push(j(h)),c===!0&&(a("head").append(h),d.push(j(h)))}}else if(h.is("script")){var o=h.attr("src");if(o){var p=a('head > script[src="'+o+'"]');p.length>0?(f.push(j(p)),p.remove()):e.push(j(h)),c===!0&&(a("head").append(h),d.push(j(h)))}}else h.is("style")&&c===!0&&(a("head").append(h),d.push(j(h)),e.push(j(h)))}),[d,e,f]}function f(b,c,d,f){var g=[],h=[],i=[];if("forward"===b)a("head > [data-remove-on-pjaxr]").each(function(){var b=a(this);i.push(j(b)),b.remove()});else if("back"===b){var k=e(d,!1),l=e(f,!0);a.extend(h,k[1]),a.extend(i,l[2])}var m=e(c,!0);return a.extend(g,m[0]),a.extend(h,m[1]),a.extend(i,m[2]),[g,h,i]}function g(b){var c=[],d=[];return b&&b.length>0&&a.each(b,function(b,e){var f=a(e),g=f.attr("id");if(g){var h=a("#"+g);if(h.length>0){d.push(j(h));try{h.html(f.html())}catch(i){window.console&&console.error(i)}c.push(j(h))}}}),[c,d]}function h(b,c){var d=a.Event(b);return a(document).trigger(d,c),!d.isDefaultPrevented()}function i(b){return a.parseHTML(b,document,!0)}function j(a){return a.clone().wrap("<p>").parent().html()}function k(){return(new Date).getTime()}function l(a){window.history.replaceState(null,"","#"),window.location.replace(a)}function m(a){var c=a.state;if(c){if(r&&s==c.url)return;h("pjaxr:start",[b.options]),document.title=c.title;var d=b.state.id<c.id?"forward":"back";f(d,c.head_apply,c.head_revert,c.head_remove);var e="forward"===d?c.body_apply:c.body_revert;e&&e.length>0&&g(e),b.state=c,q=c.namespace,document.body.offsetHeight,h("pjaxr:end",[b.options])}r=!1}function n(){return a("meta").filter(function(){return"X-PJAX-VERSION"===String(a(this).attr("http-equiv")).toUpperCase()}).attr("content")}function o(){a.fn.pjaxr=b,a.fn.pjaxr.click=d,a.fn.pjaxr.request=c,a.fn.pjaxr.enable=a.noop,a.fn.pjaxr.disable=p,a.fn.pjaxr.defaults={timeout:650,push:!0,replace:!1,scrollTo:0,version:n},a(window).on("popstate.pjaxr",m)}function p(){a.fn.pjaxr=function(){return this},a.fn.pjaxr.enable=o,a.fn.pjaxr.disable=a.noop,a(window).off("popstate.pjaxr",m)}var q,r=!0,s=window.location.href,t=window.history.state;t&&(b.state=t),"state"in window.history&&(r=!1),a.inArray("state",a.event.props)<0&&a.event.props.push("state"),a.support.pjaxr=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/),a.support.pjaxr?o():p()}(jQuery);