/*! jQuery.pjaxR v1.0.1 | Copyright (c) 2013 Stephan Gross | MIT License | minddust.com */
(function(a){function b(a,b){return this.on("click.pjaxr",a,function(a){u(a,b)})}function u(c,h){var d=c.currentTarget;if("A"!==d.tagName.toUpperCase())throw"$.fn.pjaxXR requires an anchor element";if(!(1<c.which||c.metaKey||c.ctrlKey||c.shiftKey||c.altKey||c.isDefaultPrevented()||location.protocol!==d.protocol||location.hostname!==d.hostname||d.hash&&d.href.replace(d.hash,"")===location.href.replace(location.hash,"")||d.href===location.href+"#")){var d={url:a.isFunction(d.href)?d.href():d.href,type:"GET",dataType:"html",target:d},e=b.options=a.extend(!0,{},a.ajaxSettings,d,a.fn.pjaxr.defaults,h);if(l("pjaxr:click",[e])){var k;e.beforeSend=function(a,c){if(!l("pjaxr:beforeSend",[a,c]))return!1;a.setRequestHeader("X-PJAX","true");0<c.timeout&&(k=setTimeout(function(){l("pjaxr:timeout",[a,e])&&a.abort("timeout")},c.timeout),c.timeout=0);return!0};b.state||(b.state={id:(new Date).getTime(),url:window.location.href,title:document.title},window.history.replaceState(b.state,b.state.title,b.state.url));(d=b.xhr)&&4>d.readyState&&(d.onreadystatechange=a.noop,d.abort());d=b.xhr=a.ajax(e);0<d.readyState&&l("pjaxr:start",[e]);d.done(function(c,d,g){var f="function"===typeof e.version?e.version():e.version,h=g.getResponseHeader("X-PJAX-Version");if(f&&h&&f!==h)t(e.url);else if(f=c.match(/<pjaxr-head>([\s\S.]*)<\/pjaxr-head>/i),h=c.match(/<pjaxr-body>([\s\S.]*)<\/pjaxr-body>/i),f||h){document.activeElement.blur();var k=(new Date).getTime();if(f)var s=a(a.parseHTML(f[0],document,!0)),p=v("forward",s.children(),null,null),s=p[0],q=p[1],p=p[2];if(h)var m=a(a.parseHTML(h[0],document,!0)),r=w(m.children()),m=r[0],r=r[1];a(document).find("input[autofocus], textarea[autofocus]").last().focus();"number"===typeof e.scrollTo&&a(window).scrollTop(e.scrollTo);a.extend(b.state,{head_revert:f?q:null,head_remove:f?p:null,body_revert:h?r:null});(e.push||e.replace)&&window.history.replaceState(b.state,b.state.title,b.state.url);b.state={id:k,url:e.url,title:document.title,head_apply:f?s:null,body_apply:h?m:null};e.push?window.history.pushState(b.state,b.state.title,b.state.url):e.replace&&window.history.replaceState(b.state,b.state.title,b.state.url);l("pjaxr:done",[c,d,g,e])}else t(e.url)});d.fail(function(a,c,d){"abort"!==c&&l("pjaxr:fail",[a,c,d,e])&&t(e.url)});d.always(function(){k&&clearTimeout(k);l("pjaxr:always",[e]);l("pjaxr:end",[e])})}c.preventDefault()}}function q(c,h){var d=[],e=[],b=[];c&&0<c.length&&a.each(c,function(c,n){var g=a(n);if(g.is("title"))document.title=g.text();else if(g.is("meta")){var f,l=g.attr("name"),m=g.attr("property");l?f=a('head > meta[name="'+l+'"]'):m&&(f=a('head > meta[property="'+m+'"]'));0<f.length?(b.push(k(f)),f.remove()):e.push(k(g));!0===h&&(a("head").append(g),d.push(k(g)))}else if(g.is("link")){if(f=g.attr("href"))f=a('head > link[href="'+f+'"]'),0<f.length?(b.push(k(f)),f.remove()):e.push(k(g)),!0===h&&(a("head").append(g),d.push(k(g)))}else if(g.is("script")){if(f=g.attr("src"))f=a('head > script[src="'+f+'"]'),0<f.length?(b.push(k(f)),f.remove()):e.push(k(g)),!0===h&&(a("head").append(g),d.push(k(g)))}else g.is("style")&&!0===h&&(a("head").append(g),d.push(k(g)),e.push(k(g)))});return[d,e,b]}function v(c,b,d,e){var l=[],m=[],n=[];"forward"===c?a("head > [data-remove-on-pjaxr]").each(function(){var c=a(this);n.push(k(c));c.remove()}):"back"===c&&(c=q(d,!1),e=q(e,!0),a.extend(m,c[1]),a.extend(n,e[2]));b=q(b,!0);a.extend(l,b[0]);a.extend(m,b[1]);a.extend(n,b[2]);return[l,m,n]}function w(c){var b=[],d=[];c&&0<c.length&&a.each(c,function(c,l){var m=a(l),n=m.attr("id");n&&(n=a("#"+n),0<n.length&&(d.push(k(n)),n.html(m.html()),b.push(k(n))))});return[b,d]}function l(c,h){var d=a.Event(c,{relatedTarget:b.options.target});a(document).trigger(d,h);return!d.isDefaultPrevented()}function k(a){return a.clone().wrap("<p>").parent().html()}function t(a){window.history.replaceState(null,"","#");window.location.replace(a)}function x(a){if(a=a.state){if(m&&B==a.url)return;l("pjaxr:start",[b.options]);document.title=a.title;var h=b.state.id<a.id?"forward":"back";v(h,a.head_apply,a.head_revert,a.head_remove);(h="forward"===h?a.body_apply:a.body_revert)&&0<h.length&&w(h);b.state=a;document.body.offsetHeight;l("pjaxr:end",[b.options])}m=!1}function C(){return a("meta").filter(function(){return"X-PJAX-VERSION"===String(a(this).attr("http-equiv")).toUpperCase()}).attr("content")}function y(){a.fn.pjaxr=b;a.fn.pjaxr.click=u;a.fn.pjaxr.enable=a.noop;a.fn.pjaxr.disable=z;a.fn.pjaxr.defaults={timeout:650,push:!0,replace:!1,scrollTo:0,version:C};a(window).on("popstate.pjaxr",x)}function z(){a.fn.pjaxr=function(){return this};a.fn.pjaxr.enable=y;a.fn.pjaxr.disable=a.noop;a(window).off("popstate.pjaxr",x)}var m=!0,B=window.location.href,A=window.history.state;A&&(b.state=A);"state"in window.history&&(m=!1);0>a.inArray("state",a.event.props)&&a.event.props.push("state");a.support.pjaxr=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/);a.support.pjaxr?y():z()})(jQuery);