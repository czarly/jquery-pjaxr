/*! jQuery.pjaxR v1.0.2 | Copyright (c) 2013 Stephan Gross | MIT License | minddust.com */
(function(a){function b(a,b){return this.on("click.pjaxr",a,function(a){v(a,b)})}function v(c,f){var h=c.currentTarget;if("A"!==h.tagName.toUpperCase())throw"$.fn.pjaxXR requires an anchor element";if(!(1<c.which||c.metaKey||c.ctrlKey||c.shiftKey||c.altKey||c.isDefaultPrevented()||location.protocol!==h.protocol||location.hostname!==h.hostname||h.hash&&h.href.replace(h.hash,"")===location.href.replace(location.hash,"")||h.href===location.href+"#")){var e={url:a.isFunction(h.href)?h.href():h.href,type:"GET",dataType:"html",target:h},d=b.options=a.extend(!0,{},a.ajaxSettings,e,a.fn.pjaxr.defaults,f);if(k("pjaxr:click",[d])){var l;d.beforeSend=function(a,c){if(!k("pjaxr:beforeSend",[a,c]))return!1;a.setRequestHeader("X-PJAX","true");var b=h.data("pjaxr-namespace")||d.namespace;b&&a.setRequestHeader("X-PJAX-NAMESPACE",b);0<c.timeout&&(l=setTimeout(function(){k("pjaxr:timeout",[a,d])&&a.abort("timeout")},c.timeout),c.timeout=0);return!0};b.state||(b.state={id:(new Date).getTime(),url:window.location.href,title:document.title},window.history.replaceState(b.state,b.state.title,b.state.url));(e=b.xhr)&&4>e.readyState&&(e.onreadystatechange=a.noop,e.abort());e=b.xhr=a.ajax(d);0<e.readyState&&k("pjaxr:start",[d]);e.done(function(c,g,h){var f="function"===typeof d.version?d.version():d.version,e=h.getResponseHeader("X-PJAX-Version");if(f&&e&&f!==e)u(d.url);else if(f=c.match(/<pjaxr-head>([\s\S.]*)<\/pjaxr-head>/i),e=c.match(/<pjaxr-body>([\s\S.]*)<\/pjaxr-body>/i),f||e){document.activeElement.blur();var l=(new Date).getTime();if(f)var t=a(a.parseHTML(f[0],document,!0)),q=w("forward",t.children(),null,null),t=q[0],r=q[1],q=q[2];if(e)var p=a(a.parseHTML(e[0],document,!0)),s=x(p.children()),p=s[0],s=s[1];a(document).find("input[autofocus], textarea[autofocus]").last().focus();"number"===typeof d.scrollTo&&a(window).scrollTop(d.scrollTo);a.extend(b.state,{head_revert:f?r:null,head_remove:f?q:null,body_revert:e?s:null});(d.push||d.replace)&&window.history.replaceState(b.state,b.state.title,b.state.url);b.state={id:l,url:d.url,title:document.title,head_apply:f?t:null,body_apply:e?p:null};d.push?window.history.pushState(b.state,b.state.title,b.state.url):d.replace&&window.history.replaceState(b.state,b.state.title,b.state.url);k("pjaxr:done",[c,g,h,d])}else u(d.url)});e.fail(function(a,c,f){"abort"!==c&&k("pjaxr:fail",[a,c,f,d])&&u(d.url)});e.always(function(){l&&clearTimeout(l);k("pjaxr:always",[d]);k("pjaxr:end",[d])})}c.preventDefault()}}function r(c,f){var b=[],e=[],d=[];c&&0<c.length&&a.each(c,function(c,n){var g=a(n);if(g.is("title"))document.title=g.text();else if(g.is("meta")){var m,k=g.attr("name"),p=g.attr("property");k?m=a('head > meta[name="'+k+'"]'):p&&(m=a('head > meta[property="'+p+'"]'));0<m.length?(d.push(l(m)),m.remove()):e.push(l(g));!0===f&&(a("head").append(g),b.push(l(g)))}else if(g.is("link")){if(m=g.attr("href"))m=a('head > link[href="'+m+'"]'),0<m.length?(d.push(l(m)),m.remove()):e.push(l(g)),!0===f&&(a("head").append(g),b.push(l(g)))}else if(g.is("script")){if(m=g.attr("src"))m=a('head > script[src="'+m+'"]'),0<m.length?(d.push(l(m)),m.remove()):e.push(l(g)),!0===f&&(a("head").append(g),b.push(l(g)))}else g.is("style")&&!0===f&&(a("head").append(g),b.push(l(g)),e.push(l(g)))});return[b,e,d]}function w(c,b,h,e){var d=[],k=[],n=[];"forward"===c?a("head > [data-remove-on-pjaxr]").each(function(){var c=a(this);n.push(l(c));c.remove()}):"back"===c&&(c=r(h,!1),e=r(e,!0),a.extend(k,c[1]),a.extend(n,e[2]));b=r(b,!0);a.extend(d,b[0]);a.extend(k,b[1]);a.extend(n,b[2]);return[d,k,n]}function x(c){var b=[],h=[];c&&0<c.length&&a.each(c,function(c,d){var k=a(d),n=k.attr("id");n&&(n=a("#"+n),0<n.length&&(h.push(l(n)),n.html(k.html()),b.push(l(n))))});return[b,h]}function k(c,f){var h=a.Event(c,{relatedTarget:b.options.target});a(document).trigger(h,f);return!h.isDefaultPrevented()}function l(a){return a.clone().wrap("<p>").parent().html()}function u(a){window.history.replaceState(null,"","#");window.location.replace(a)}function y(a){if(a=a.state){if(p&&C==a.url)return;k("pjaxr:start",[b.options]);document.title=a.title;var f=b.state.id<a.id?"forward":"back";w(f,a.head_apply,a.head_revert,a.head_remove);(f="forward"===f?a.body_apply:a.body_revert)&&0<f.length&&x(f);b.state=a;document.body.offsetHeight;k("pjaxr:end",[b.options])}p=!1}function D(){return a("meta").filter(function(){return"X-PJAX-VERSION"===String(a(this).attr("http-equiv")).toUpperCase()}).attr("content")}function z(){a.fn.pjaxr=b;a.fn.pjaxr.click=v;a.fn.pjaxr.enable=a.noop;a.fn.pjaxr.disable=A;a.fn.pjaxr.defaults={timeout:650,push:!0,replace:!1,scrollTo:0,version:D};a(window).on("popstate.pjaxr",y)}function A(){a.fn.pjaxr=function(){return this};a.fn.pjaxr.enable=z;a.fn.pjaxr.disable=a.noop;a(window).off("popstate.pjaxr",y)}var p=!0,C=window.location.href,B=window.history.state;B&&(b.state=B);"state"in window.history&&(p=!1);0>a.inArray("state",a.event.props)&&a.event.props.push("state");a.support.pjaxr=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/);a.support.pjaxr?z():A()})(jQuery);