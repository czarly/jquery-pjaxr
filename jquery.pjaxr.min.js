/*! jQuery.pjaxR v1.0.4 | Copyright (c) 2013 Stephan Gross | MIT License | minddust.com */
!function(a){"use strict";function b(a,b){return this.on("click.pjaxr",a,function(a){c(a,b)})}function c(c,d){var i=c.currentTarget;if("A"!==i.tagName.toUpperCase())throw"$.fn.pjaxr requires an anchor element";if(!(c.which>1||c.metaKey||c.ctrlKey||c.shiftKey||c.altKey||c.isDefaultPrevented()||location.protocol!==i.protocol||location.hostname!==i.hostname||i.hash&&i.href.replace(i.hash,"")===location.href.replace(location.hash,"")||i.href===location.href+"#")){var l={url:a.isFunction(i.href)?i.href():i.href,type:"GET",dataType:"html"},m=b.options=a.extend(!0,{},a.ajaxSettings,l,a.fn.pjaxr.defaults,d);if(!g("pjaxr:click",[m]))return c.preventDefault(),void 0;p||(p=a("body").data("pjaxr-namespace")||"");var n;m.beforeSend=function(a,b){return g("pjaxr:beforeSend",[a,b])?(a.setRequestHeader("X-PJAX","true"),a.setRequestHeader("X-PJAX-NAMESPACE",p),b.timeout>0&&(n=setTimeout(function(){g("pjaxr:timeout",[a,m])&&a.abort("timeout")},b.timeout),b.timeout=0),!0):!1},b.state||(b.state={id:j(),namespace:p,url:window.location.href,title:document.title},window.history.replaceState(b.state,b.state.title,b.state.url));var o=b.xhr;o&&o.readyState<4&&(o.onreadystatechange=a.noop,o.abort()),o=b.xhr=a.ajax(m),o.readyState>0&&g("pjaxr:start",[m]),o.done(function(c,d,i){g("pjaxr:success",[m]);var l="function"==typeof m.version?m.version():m.version,n=i.getResponseHeader("X-PJAX-Version");if(l&&n&&l!==n)return k(m.url),void 0;var o=c.match(/<pjaxr-head>([\s\S.]*)<\/pjaxr-head>/i),q=c.match(/<pjaxr-body>([\s\S.]*)<\/pjaxr-body>/i);if(!o&&!q)return k(m.url),void 0;g("pjaxr:success",[c,d,i,m]),document.activeElement.blur();var r=j();if(o)var s=a(h(o[0])),t=e("forward",s.children(),null,null),u=t[0],v=t[1],w=t[2];if(q)var x=a(h(q[0])),y=f(x.children()),z=y[0],A=y[1];var B=c.match(/<pjaxr-namespace>([\s\S.]*)<\/pjaxr-namespace>/i);B&&(p=a(h(B[0])).html()),a(document).find("input[autofocus], textarea[autofocus]").last().focus(),"number"==typeof m.scrollTo&&a(window).scrollTop(m.scrollTo),a.extend(b.state,{head_revert:o?v:null,head_remove:o?w:null,body_revert:q?A:null}),(m.push||m.replace)&&window.history.replaceState(b.state,b.state.title,b.state.url),b.state={id:r,namespace:p,url:m.url,title:document.title,head_apply:o?u:null,body_apply:q?z:null},m.push?window.history.pushState(b.state,b.state.title,b.state.url):m.replace&&window.history.replaceState(b.state,b.state.title,b.state.url),g("pjaxr:done",[c,d,i,m])}),o.fail(function(a,b,c){"abort"!==b&&g("pjaxr:fail",[a,b,c,m])&&k(m.url)}),o.always(function(){n&&clearTimeout(n),g("pjaxr:always",[m]),g("pjaxr:end",[m])}),c.preventDefault()}}function d(b,c){var d=[],e=[],f=[];return b&&b.length>0&&a.each(b,function(b,g){var h=a(g);if(h.is("title"))document.title=h.text();else if(h.is("meta")){var j,k=h.attr("name"),l=h.attr("property");k?j=a('head > meta[name="'+k+'"]'):l&&(j=a('head > meta[property="'+l+'"]')),j.length>0?(f.push(i(j)),j.remove()):e.push(i(h)),c===!0&&(a("head").append(h),d.push(i(h)))}else if(h.is("link")){var m=h.attr("href");if(m){var n=a('head > link[href="'+m+'"]');n.length>0?(f.push(i(n)),n.remove()):e.push(i(h)),c===!0&&(a("head").append(h),d.push(i(h)))}}else if(h.is("script")){var o=h.attr("src");if(o){var p=a('head > script[src="'+o+'"]');p.length>0?(f.push(i(p)),p.remove()):e.push(i(h)),c===!0&&(a("head").append(h),d.push(i(h)))}}else h.is("style")&&c===!0&&(a("head").append(h),d.push(i(h)),e.push(i(h)))}),[d,e,f]}function e(b,c,e,f){var g=[],h=[],j=[];if("forward"===b)a("head > [data-remove-on-pjaxr]").each(function(){var b=a(this);j.push(i(b)),b.remove()});else if("back"===b){var k=d(e,!1),l=d(f,!0);a.extend(h,k[1]),a.extend(j,l[2])}var m=d(c,!0);return a.extend(g,m[0]),a.extend(h,m[1]),a.extend(j,m[2]),[g,h,j]}function f(b){var c=[],d=[];return b&&b.length>0&&a.each(b,function(b,e){var f=a(e),g=f.attr("id");if(g){var h=a("#"+g);h.length>0&&(d.push(i(h)),h.html(f.html()),c.push(i(h)))}}),[c,d]}function g(b,c){var d=a.Event(b);return a(document).trigger(d,c),!d.isDefaultPrevented()}function h(b){return a.parseHTML(b,document,!0)}function i(a){return a.clone().wrap("<p>").parent().html()}function j(){return(new Date).getTime()}function k(a){window.history.replaceState(null,"","#"),window.location.replace(a)}function l(a){var c=a.state;if(c){if(q&&r==c.url)return;g("pjaxr:start",[b.options]),document.title=c.title;var d=b.state.id<c.id?"forward":"back";e(d,c.head_apply,c.head_revert,c.head_remove);var h="forward"===d?c.body_apply:c.body_revert;h&&h.length>0&&f(h),b.state=c,p=c.namespace,document.body.offsetHeight,g("pjaxr:end",[b.options])}q=!1}function m(){return a("meta").filter(function(){return"X-PJAX-VERSION"===String(a(this).attr("http-equiv")).toUpperCase()}).attr("content")}function n(){a.fn.pjaxr=b,a.fn.pjaxr.click=c,a.fn.pjaxr.enable=a.noop,a.fn.pjaxr.disable=o,a.fn.pjaxr.defaults={timeout:650,push:!0,replace:!1,scrollTo:0,version:m},a(window).on("popstate.pjaxr",l)}function o(){a.fn.pjaxr=function(){return this},a.fn.pjaxr.enable=n,a.fn.pjaxr.disable=a.noop,a(window).off("popstate.pjaxr",l)}var p,q=!0,r=window.location.href,s=window.history.state;s&&(b.state=s),"state"in window.history&&(q=!1),a.inArray("state",a.event.props)<0&&a.event.props.push("state"),a.support.pjaxr=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/),a.support.pjaxr?n():o()}(jQuery);